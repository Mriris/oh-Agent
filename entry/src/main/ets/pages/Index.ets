import { hilog } from '@kit.PerformanceAnalysisKit';
import { AutoGLMService, TaskCallback } from '../services/AutoGLMService';
import { preferences } from '@kit.ArkData';

// ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€æšä¸¾
enum TaskStatus {
  IDLE = 'idle',
  CONNECTING = 'connecting',
  EXECUTING = 'executing',
  SUCCESS = 'success',
  FAILED = 'failed'
}

@Entry
@Component
struct Index {
  // çŠ¶æ€ç®¡ç†
  @State taskInput: string = '';
  @State taskStatus: TaskStatus = TaskStatus.IDLE;
  @State statusMessage: string = 'æœªè¿æ¥';
  @State isAnimating: boolean = false;
  @State aiThinking: string = '';
  @State currentAction: string = '';
  @State stepCount: number = 0;
  @State isConnected: boolean = false;  // è¿æ¥çŠ¶æ€ï¼ˆç”¨äº UI åˆ·æ–°ï¼‰
  @State expandedStatus: boolean = false;  // çŠ¶æ€åŒºåŸŸæ˜¯å¦å±•å¼€

  // é…ç½®
  @State serverUrl: string = 'http://192.168.1.105:7860';
  @State deviceId: string = '127.0.0.1:5555';  // HDC é»˜è®¤è®¾å¤‡
  @State showConfig: boolean = false;

  // æœåŠ¡å®ä¾‹
  private autoGLMService: AutoGLMService = new AutoGLMService();

  // ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ
  async aboutToAppear() {
    await this.loadConfig();
    await this.initService();
  }

  // åŠ è½½é…ç½®
  async loadConfig(): Promise<void> {
    try {
      const context = getContext(this);
      const dataPreferences = preferences.getPreferencesSync(context, { name: 'agent_config' });

      const savedServerUrl = dataPreferences.getSync('serverUrl', this.serverUrl) as string;
      const savedDeviceId = dataPreferences.getSync('deviceId', this.deviceId) as string;

      this.serverUrl = savedServerUrl;
      this.deviceId = savedDeviceId;

      hilog.info(0x0000, 'Agent', `é…ç½®å·²åŠ è½½: ${this.serverUrl}, ${this.deviceId}`);
    } catch (error) {
      hilog.warn(0x0000, 'Agent', 'åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
    }
  }

  // ä¿å­˜é…ç½®
  async saveConfig(): Promise<void> {
    try {
      const context = getContext(this);
      const dataPreferences = preferences.getPreferencesSync(context, { name: 'agent_config' });

      dataPreferences.putSync('serverUrl', this.serverUrl);
      dataPreferences.putSync('deviceId', this.deviceId);
      dataPreferences.flush();

      hilog.info(0x0000, 'Agent', 'é…ç½®å·²ä¿å­˜');
      this.updateStatus(TaskStatus.IDLE, 'é…ç½®å·²ä¿å­˜');
    } catch (error) {
      hilog.error(0x0000, 'Agent', `ä¿å­˜é…ç½®å¤±è´¥: ${error}`);
    }
  }

  // åˆå§‹åŒ–æœåŠ¡
  async initService(): Promise<void> {
    try {
      this.updateStatus(TaskStatus.CONNECTING, 'è¿æ¥ä¸­...');
      this.isConnected = false;

      // é…ç½®æœåŠ¡
      this.autoGLMService.configure(this.serverUrl, this.deviceId);

      // è¿æ¥åˆ°åç«¯
      await this.autoGLMService.connect();

      this.updateStatus(TaskStatus.IDLE, 'å·²è¿æ¥');
      this.isConnected = true;
      hilog.info(0x0000, 'Agent', 'æœåŠ¡åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      hilog.error(0x0000, 'Agent', `åˆå§‹åŒ–å¤±è´¥: ${errorMsg}`);
      this.updateStatus(TaskStatus.FAILED, `è¿æ¥å¤±è´¥: ${errorMsg}`);
      this.isConnected = false;
    }
  }

  // é‡æ–°è¿æ¥
  async reconnect(): Promise<void> {
    this.autoGLMService.disconnect();
    this.isConnected = false;
    await this.initService();
  }

  // æ‰§è¡Œä»»åŠ¡
  async executeTask(): Promise<void> {
    if (!this.taskInput.trim()) {
      this.updateStatus(TaskStatus.FAILED, 'è¯·è¾“å…¥ä»»åŠ¡æŒ‡ä»¤');
      return;
    }

    if (!this.isConnected) {
      this.updateStatus(TaskStatus.FAILED, 'æœªè¿æ¥åˆ°åç«¯');
      return;
    }

    this.updateStatus(TaskStatus.EXECUTING, 'æ­£åœ¨æ‰§è¡Œ...');
    this.aiThinking = '';
    this.currentAction = '';
    this.stepCount = 0;

    try {
      const callback: TaskCallback = {
        onStarted: () => {
          this.updateStatus(TaskStatus.EXECUTING, 'ä»»åŠ¡å·²å¼€å§‹');
        },
        onThinking: (thinking: string) => {
          this.aiThinking = thinking;
          this.updateStatus(TaskStatus.EXECUTING, 'AI æ­£åœ¨æ€è€ƒ...');
        },
        onAction: (action: string) => {
          this.currentAction = action;
          this.stepCount++;
          this.updateStatus(TaskStatus.EXECUTING, `æ‰§è¡Œä¸­ (æ­¥éª¤ ${this.stepCount})...`);
        },
        onCompleted: (result: string, steps: number) => {
          this.stepCount = steps;
          this.updateStatus(TaskStatus.SUCCESS, `å®Œæˆ: ${result}`);
        },
        onFailed: (error: string) => {
          this.updateStatus(TaskStatus.FAILED, `å¤±è´¥: ${error}`);
        }
      };

      await this.autoGLMService.executeTask(this.taskInput, callback);
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      hilog.error(0x0000, 'Agent', `ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${errorMsg}`);
      this.updateStatus(TaskStatus.FAILED, `æ‰§è¡Œå¤±è´¥: ${errorMsg}`);
    }
  }

  // æ›´æ–°çŠ¶æ€
  updateStatus(status: TaskStatus, message: string): void {
    this.taskStatus = status;
    this.statusMessage = message;
    // æ–°çŠ¶æ€æ—¶è‡ªåŠ¨æ”¶èµ·å±•å¼€åŒºåŸŸ
    this.expandedStatus = false;
  }

  // è·å–çŠ¶æ€é¢œè‰²
  getStatusColor(): string {
    switch (this.taskStatus) {
      case TaskStatus.IDLE:
        return '#8892b0';
      case TaskStatus.CONNECTING:
        return '#a200ff';
      case TaskStatus.EXECUTING:
        return '#00d9ff';
      case TaskStatus.SUCCESS:
        return '#05ffa1';
      case TaskStatus.FAILED:
        return '#ff2a6d';
      default:
        return '#8892b0';
    }
  }

  build() {
    Stack() {
      // èµ›åšæœ‹å…‹é£æ ¼èƒŒæ™¯
      this.buildBackground()

      // å¯æ»šåŠ¨å†…å®¹
      Scroll() {
        Column() {
          // æ ‡é¢˜
          this.buildTitle()

          // è¿æ¥çŠ¶æ€å’Œé…ç½®æŒ‰é’®
          this.buildConnectionStatus()

          // é…ç½®ç•Œé¢ï¼ˆå¯å±•å¼€ï¼‰
          if (this.showConfig) {
            this.buildConfigPanel()
          }

          // è¾“å…¥åŒºåŸŸ
          this.buildInputArea()

          // æŒ‰é’®ç»„
          this.buildButtonGroup()

          // AI æ€è€ƒæ˜¾ç¤º
          if (this.aiThinking) {
            this.buildThinkingArea()
          }

          // åŠ¨ä½œæ˜¾ç¤º
          if (this.currentAction) {
            this.buildActionArea()
          }

          // çŠ¶æ€æ˜¾ç¤º
          this.buildStatusArea()
        }
        .width('90%')
        .padding(24)
      }
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Top)
  }

  // èƒŒæ™¯ç»„ä»¶
  @Builder
  buildBackground() {
    Column()
      .width('100%')
      .height('100%')
      .linearGradient({
        angle: 180,
        colors: [
          ['#0a0e27', 0.0],
          ['#1a1a2e', 0.5],
          ['#0a0e27', 1.0]
        ]
      })
  }

  // æ ‡é¢˜ç»„ä»¶
  @Builder
  buildTitle() {
    Column() {
      Text('AGENT CONTROLLER')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor('#ffffff')
        .textShadow({
          radius: 20,
          color: '#00d9ff',
          offsetX: 0,
          offsetY: 0
        })
        .letterSpacing(2)

      Text('AutoGLM Real Control')
        .fontSize(12)
        .fontColor('#8892b0')
        .margin({ top: 8 })
        .letterSpacing(1)
    }
    .margin({ top: 24, bottom: 24 })
  }

  // è¿æ¥çŠ¶æ€ç»„ä»¶
  @Builder
  buildConnectionStatus() {
    Row() {
      Row() {
        Circle()
          .width(8)
          .height(8)
          .fill(this.isConnected ? '#05ffa1' : '#ff2a6d')
          .shadow({
            radius: 6,
            color: this.isConnected ? '#05ffa1' : '#ff2a6d',
            offsetX: 0,
            offsetY: 0
          })
          .margin({ right: 8 })

        Text(this.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥')
          .fontSize(12)
          .fontColor('#ffffff')
      }

      Row() {
        Button('é…ç½®')
          .fontSize(12)
          .height(32)
          .padding({ left: 16, right: 16 })
          .backgroundColor('rgba(0, 217, 255, 0.2)')
          .borderRadius(16)
          .onClick(() => {
            this.showConfig = !this.showConfig;
          })

        if (!this.isConnected) {
          Button('é‡è¿')
            .fontSize(12)
            .height(32)
            .padding({ left: 16, right: 16 })
            .backgroundColor('rgba(5, 255, 161, 0.2)')
            .borderRadius(16)
            .margin({ left: 8 })
            .onClick(() => {
              this.reconnect();
            })
        }
      }
    }
    .width('100%')
    .height(48)
    .padding({ left: 16, right: 16 })
    .backgroundColor('rgba(26, 26, 46, 0.6)')
    .borderRadius(8)
    .borderWidth(1)
    .borderColor('rgba(0, 217, 255, 0.2)')
    .justifyContent(FlexAlign.SpaceBetween)
    .margin({ bottom: 16 })
  }

  // é…ç½®é¢æ¿
  @Builder
  buildConfigPanel() {
    Column() {
      Text('åç«¯é…ç½®')
        .fontSize(14)
        .fontColor('#8892b0')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)

      Column() {
        Text('æœåŠ¡å™¨åœ°å€')
          .fontSize(12)
          .fontColor('#8892b0')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 4 })

        TextInput({ placeholder: 'http://192.168.1.100:7860', text: this.serverUrl })
          .fontSize(14)
          .fontColor('#ffffff')
          .backgroundColor('rgba(0, 217, 255, 0.05)')
          .borderRadius(8)
          .borderWidth(1)
          .borderColor('rgba(0, 217, 255, 0.3)')
          .onChange((value: string) => {
            this.serverUrl = value;
          })
      }
      .margin({ bottom: 12 })

      Column() {
        Text('è®¾å¤‡ ID')
          .fontSize(12)
          .fontColor('#8892b0')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 4 })

        TextInput({ placeholder: 'ç•™ç©ºä½¿ç”¨é»˜è®¤è®¾å¤‡', text: this.deviceId })
          .fontSize(14)
          .fontColor('#ffffff')
          .backgroundColor('rgba(0, 217, 255, 0.05)')
          .borderRadius(8)
          .borderWidth(1)
          .borderColor('rgba(0, 217, 255, 0.3)')
          .onChange((value: string) => {
            this.deviceId = value;
          })
      }
      .margin({ bottom: 12 })

      Button('ä¿å­˜å¹¶é‡è¿')
        .width('100%')
        .height(40)
        .fontSize(14)
        .backgroundColor('#00d9ff')
        .borderRadius(20)
        .onClick(async () => {
          await this.saveConfig();
          this.showConfig = false;
          await this.reconnect();
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('rgba(26, 26, 46, 0.8)')
    .borderRadius(12)
    .borderWidth(1)
    .borderColor('rgba(0, 217, 255, 0.3)')
    .margin({ bottom: 16 })
  }

  // è¾“å…¥åŒºåŸŸç»„ä»¶
  @Builder
  buildInputArea() {
    TextArea({
      placeholder: 'è¾“å…¥ä»»åŠ¡æŒ‡ä»¤ï¼ˆå¦‚ï¼šæ‰“å¼€è®¾ç½®ï¼‰',
      text: this.taskInput
    })
      .width('100%')
      .height(100)
      .fontSize(16)
      .fontColor('#ffffff')
      .placeholderColor('rgba(136, 146, 176, 0.5)')
      .backgroundColor('rgba(0, 217, 255, 0.05)')
      .borderRadius(12)
      .borderWidth(2)
      .borderColor(this.isAnimating ? '#00d9ff' : 'rgba(0, 217, 255, 0.3)')
      .padding(16)
      .margin({ bottom: 16 })
      .onChange((value: string) => {
        this.taskInput = value;
      })
      .onFocus(() => {
        this.isAnimating = true;
      })
      .onBlur(() => {
        this.isAnimating = false;
      })
      .animation({
        duration: 300,
        curve: Curve.EaseInOut
      })
      .shadow({
        radius: this.isAnimating ? 20 : 10,
        color: this.isAnimating ? 'rgba(0, 217, 255, 0.5)' : 'rgba(0, 217, 255, 0.2)',
        offsetX: 0,
        offsetY: 0
      })
      .animation({
        duration: 300,
        curve: Curve.EaseInOut
      })
  }

  // æŒ‰é’®ç»„
  @Builder
  buildButtonGroup() {
    Row() {
      Button('æ‰§è¡Œä»»åŠ¡')
        .width('100%')
        .height(50)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#0a0e27')
        .backgroundColor('#00d9ff')
        .borderRadius(25)
        .enabled(this.taskStatus !== TaskStatus.EXECUTING && this.isConnected)
        .opacity(this.taskStatus === TaskStatus.EXECUTING ? 0.6 : 1.0)
        .onClick(() => {
          this.executeTask();
        })
        .shadow({
          radius: 25,
          color: 'rgba(0, 217, 255, 0.6)',
          offsetX: 0,
          offsetY: 0
        })
        .stateEffect(true)
    }
    .width('100%')
    .margin({ bottom: 24 })
  }

  // AI æ€è€ƒåŒºåŸŸ
  @Builder
  buildThinkingArea() {
    Column() {
      Text('ğŸ’­ AI æ€è€ƒ')
        .fontSize(12)
        .fontColor('#8892b0')
        .margin({ bottom: 8 })

      Text(this.aiThinking)
        .fontSize(14)
        .fontColor('#ffffff')
        .lineHeight(20)
        .maxLines(5)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('rgba(0, 217, 255, 0.08)')
    .borderRadius(8)
    .borderWidth(1)
    .borderColor('rgba(0, 217, 255, 0.2)')
    .alignItems(HorizontalAlign.Start)
    .margin({ bottom: 16 })
  }

  // åŠ¨ä½œåŒºåŸŸ
  @Builder
  buildActionArea() {
    Column() {
      Text('âš¡ æ‰§è¡ŒåŠ¨ä½œ')
        .fontSize(12)
        .fontColor('#8892b0')
        .margin({ bottom: 8 })

      Text(this.currentAction)
        .fontSize(14)
        .fontColor('#05ffa1')
        .fontFamily('monospace')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('rgba(5, 255, 161, 0.08)')
    .borderRadius(8)
    .borderWidth(1)
    .borderColor('rgba(5, 255, 161, 0.2)')
    .alignItems(HorizontalAlign.Start)
    .margin({ bottom: 16 })
  }

  // çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
  @Builder
  buildStatusArea() {
    Column() {
      Row() {
        Text('çŠ¶æ€')
          .fontSize(12)
          .fontColor('#8892b0')

        if (this.statusMessage.length > 50) {
          Text(this.expandedStatus ? 'æ”¶èµ· â–²' : 'å±•å¼€ â–¼')
            .fontSize(10)
            .fontColor('#00d9ff')
            .margin({ left: 8 })
            .onClick(() => {
              this.expandedStatus = !this.expandedStatus;
            })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 8 })

      Column() {
        Row() {
          Circle()
            .width(10)
            .height(10)
            .fill(this.getStatusColor())
            .shadow({
              radius: 8,
              color: this.getStatusColor(),
              offsetX: 0,
              offsetY: 0
            })
            .margin({ right: 10 })
            .alignSelf(ItemAlign.Start)

          if (this.expandedStatus || this.statusMessage.length <= 50) {
            // å±•å¼€æ¨¡å¼æˆ–çŸ­æ–‡æœ¬ï¼šæ˜¾ç¤ºå®Œæ•´å†…å®¹ï¼Œæ”¯æŒæ»šåŠ¨
            Column() {
              Scroll() {
                Text(this.statusMessage)
                  .fontSize(14)
                  .fontColor('#ffffff')
                  .lineHeight(20)
                  .wordBreak(WordBreak.BREAK_ALL)
              }
              .width('100%')
              .scrollBar(BarState.Auto)
            }
            .width('100%')
            .constraintSize({ maxHeight: 200 })
          } else {
            // æŠ˜å æ¨¡å¼ï¼šåªæ˜¾ç¤ºå‰ 50 ä¸ªå­—ç¬¦
            Text(this.statusMessage.substring(0, 50) + '...')
              .fontSize(14)
              .fontColor('#ffffff')
              .lineHeight(20)
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .onClick(() => {
                this.expandedStatus = true;
              })
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .alignItems(VerticalAlign.Top)
      }
      .width('100%')
      .backgroundColor('rgba(26, 26, 46, 0.6)')
      .borderRadius(8)
      .borderWidth(1)
      .borderColor('rgba(0, 217, 255, 0.2)')
      .animation({
        duration: 300,
        curve: Curve.EaseInOut
      })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .margin({ bottom: 24 })
  }
}
